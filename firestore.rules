rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      // Check if user has 'admin' or 'superadmin' role in their user profile
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
      );
    }
    
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'superadmin';
    }

    // User profiles: Users can read/write their own profile
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
      allow read: if isAdmin();
      
      // User's cart subcollection
      match /cart/{itemId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      // Progress subcollection
      match /progress/{lessonId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
      
      // Tests subcollection
      match /tests/{testId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      // Course Progress subcollection
      match /courseProgress/{courseId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
        
        match /lectures/{lectureId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }
      }

      // Batch Progress subcollection (for Study Module)
      match /batchProgress/{batchProgressId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
        
        match /lectures/{lectureId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }
      }
    }

    // Courses: Public read if published, Admin write
    match /courses/{courseId} {
      allow read: if request.auth != null && (
        !('visibility' in resource.data) || 
        resource.data.visibility == 'published' || 
        isAdmin()
      );
      allow write: if isAdmin();
      
      match /batches/{batchId} {
        allow read: if isAdmin() || get(/databases/$(database)/documents/courses/$(courseId)).data.visibility == 'published';
        allow write: if isAdmin();
        
        match /lessons/{lessonId} {
          // Allow authenticated users to read lessons (purchase verified at app level)
          allow read: if request.auth != null;
          allow write: if isAdmin();

          // Comments: Any authenticated user can read, create their own
          match /comments/{commentId} {
            allow read: if request.auth != null;
            allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
            allow update, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);

            // Replies subcollection
            match /replies/{replyId} {
              allow read: if request.auth != null;
              allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
              allow update, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
            }
          }
        }

        match /notes/{noteId} {
          allow read: if request.auth != null;
          allow write: if isAdmin();
        }

        match /planner/{plannerId} {
          allow read: if request.auth != null;
          allow write: if isAdmin();
        }

        match /quizzes/{quizId} {
          allow read: if request.auth != null;
          allow write: if isAdmin();
        }
      }

      // Lectures subcollection (for Study Module)
      match /lectures/{lectureId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
      }
    }

    // Purchases: User create own, Admin read/write
    match /purchases/{purchaseId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow update, delete: if isAdmin();
    }

    // Enrollments: Read own, Write only via Admin/Functions
    match /enrollments/{enrollmentId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }

    // Feed: Public/Auth read, Admin write
    match /feed/{feedId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Audits: Admin read/write
    match /audits/{auditId} {
      allow read, write: if isAdmin();
    }
    
    // Admins collection (if used instead of custom claims)
    match /admins/{adminId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // --- STUDY MODULE RULES ---

    // Live Classes: Public/Auth read, Admin write
    match /live_classes/{classId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Mock Tests: Public/Auth read, Admin write
    match /mock_tests/{testId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Questions: Public/Auth read, Admin write
    match /questions/{questionId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Topic Nodes (Map Work): Public/Auth read, Admin write
    match /topics/{topicId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Daily Practice: Public/Auth read, Admin write
    match /daily_practice/{practiceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Workbooks: User specific
    match /workbooks/{workbookId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
